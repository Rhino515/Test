<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rastreador de Recorte</title>
  <style>
    body {
      background-color: #111;
      color: #fff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      text-align: center;
    }
    .lang-toggle {
      position: absolute;
      top: 20px;
      right: 20px;
      background-color: #333;
      color: #fff;
      border: 1px solid #777;
      padding: 6px 10px;
      cursor: pointer;
    }
    img.banner {
      width: 100%;
      max-width: 800px;
      margin-bottom: 30px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      font-size: 16px;
      line-height: 1.5;
      font-weight: bold;
    }
    th, td {
      border: 1px solid #444;
      padding: 12px;
      text-align: center;
    }
    input[type="text"], input[type="number"], input[type="date"] {
      width: 100%;
      padding: 6px;
      font-size: 16px;
      font-weight: bold;
      background-color: #222;
      color: #fff;
      border: 1px solid #555;
    }
    button {
      padding: 8px 12px;
      margin: 10px 5px;
      background-color: #28a745;
      border: none;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #218838;
    }
    button.delete-row {
      background-color: #dc3545;
    }
    button.delete-row:hover {
      background-color: #c82333;
    }
    button.clear-all {
      background-color: #ffc107;
      color: #111;
    }
    button.clear-all:hover {
      background-color: #e0a800;
    }
    .collapsed {
      display: none;
    }
    a.back-link {
      display: inline-block;
      margin-top: 30px;
      color: #0af;
      text-decoration: none;
    }
  </style>
</head>
<body>
  <button class="lang-toggle" onclick="toggleLanguage()">English</button>
  <img src="trim-tracker-banner.PNG" alt="Banner del Rastreador de Recorte" class="banner" />

  <p style="color: #ccc; max-width: 700px; margin: 0 auto 20px;">
    <strong>Nota:</strong> Tus datos se guardan localmente en tu navegador y permanecerán disponibles a menos que borres tu caché o cambies de dispositivo o navegador.
  </p>

  <table id="sessionTable">
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Cepa</th>
        <th>Gramos</th>
        <th>Total</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <button onclick="addRow()">Agregar fila</button>
  <button class="clear-all" onclick="clearAllRows()">Borrar todo</button>
  <button onclick="exportCSV()">Exportar CSV</button>
  <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="importCSV(event)">
  <button onclick="document.getElementById('csvFileInput').click()">Importar CSV</button>
  <a id="backLink" class="back-link" href="index-es.html">← Volver a la Calculadora</a>

  <div id="dailyTotals" style="margin-top: 30px; text-align: left; max-width: 800px; margin-left: auto; margin-right: auto;">
    <h3>Totales Diarios</h3>
    <ul id="totalsList" style="list-style: none; padding: 0;"></ul>
  </div>
<script>
  const lang = document.documentElement.lang;
  const storageKey = `trimTrackerData-${lang}`;
  let saveTimeout;

  function debounceSave() {
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(() => {
      if ('requestIdleCallback' in window) requestIdleCallback(saveData);
      else saveData();
    }, 300);
  }

  function updateView() {
    const tbody = document.getElementById('tableBody');
    const rows = Array.from(tbody.querySelectorAll('tr')).filter(r => !r.classList.contains('collapsed-row-header'));
    const today = new Date().toISOString().slice(0, 10);
    const dateGroups = {};

    rows.forEach(row => {
      const dateInput = row.querySelector('input[type="date"]');
      const date = dateInput?.value;
      if (!date) return;
      if (!dateGroups[date]) dateGroups[date] = [];
      dateGroups[date].push(row);
    });

    tbody.innerHTML = '';

    Object.keys(dateGroups).sort((a, b) => b.localeCompare(a)).forEach(date => {
      const isToday = date === today;
      let totalGrams = 0;

      dateGroups[date].forEach(row => {
        const totalCell = row.querySelector('td:nth-child(4)');
        const grams = parseFloat(totalCell?.innerText || 0);
        totalGrams += isNaN(grams) ? 0 : grams;
      });

      if (!isToday) {
        const headerRow = document.createElement('tr');
        headerRow.className = 'collapsed-row-header';
        headerRow.style.backgroundColor = '#222';
        headerRow.style.cursor = 'pointer';

        const headerCell = document.createElement('td');
        headerCell.colSpan = 5;
        headerCell.style.textAlign = 'left';
        headerCell.innerHTML = `<span style="font-weight:bold;">➕ ${date} – Total: ${totalGrams.toFixed(2)}g</span>`;
        headerRow.setAttribute('data-collapsed', 'true');
        headerRow.addEventListener('click', () => {
          const isCollapsed = headerRow.getAttribute('data-collapsed') === 'true';
          headerRow.setAttribute('data-collapsed', String(!isCollapsed));
          headerCell.innerHTML = `<span style="font-weight:bold;">${!isCollapsed ? '➖' : '➕'} ${date} – Total: ${totalGrams.toFixed(2)}g</span>`;
          dateGroups[date].forEach(r => {
            r.style.display = isCollapsed ? '' : 'none';
          });
        });
        tbody.appendChild(headerRow);
        dateGroups[date].forEach(r => {
          r.style.display = 'none';
          tbody.appendChild(r);
        });
      } else {
        dateGroups[date].forEach(r => {
          r.style.display = '';
          tbody.appendChild(r);
        });
      }
    });
  }

  // Additional functions like createGramInput, addRow, etc., go here, ensuring they integrate with updateView as needed.

</script>
</body>
</html>
