<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Trim Tracker</title>
<style>
  body {
    background-color: #111;
    color: #fff;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    padding: 20px;
    text-align: center;
  }
  img.banner {
    width: 100%;
    max-width: 800px;
    margin-bottom: 30px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
    font-size: 16px;
    line-height: 1.5;
    font-weight: bold;
  }
  th, td {
    border: 1px solid #444;
    padding: 12px;
    text-align: center;
  }
  input[type="text"], input[type="number"], input[type="date"] {
    width: 100%;
    padding: 6px;
    font-size: 16px;
    font-weight: bold;
    background-color: #222;
    color: #fff;
    border: 1px solid #555;
  }
  button {
    padding: 8px 12px;
    margin: 10px 5px;
    background-color: #28a745;
    border: none;
    color: white;
    cursor: pointer;
  }
  button:hover { background-color: #218838; }
  button.delete-row { background-color: #dc3545; }
  button.delete-row:hover { background-color: #c82333; }
  button.clear-all { background-color: #ffc107; color: #111; }
  button.clear-all:hover { background-color: #e0a800; }

  a.back-link {
    display: inline-block;
    margin-top: 30px;
    color: #0af;
    text-decoration: none;
  }

  /* Collapsible header rows */
  tr.group-header td{
    background:#222;
    text-align:left;
    cursor:pointer;
    user-select:none;
  }
  tr.group-header td .tag{
    color:#0f0;
    font-weight:900;
    margin-right:10px;
  }
  tr.sub-header td{
    background:#1b1b1b;
    text-align:left;
    cursor:pointer;
    user-select:none;
  }
  tr.sub-header td .tag{
    color:#0f0;
    font-weight:900;
    margin-right:10px;
  }
  tr.divider-row td{
    background:#151515;
    color:#bbb;
    text-align:left;
    font-weight:800;
  }

  /* Past panel */
  #pastControls{
    width:100%;
    max-width:800px;
    margin: 0 auto 18px;
    text-align:left;
  }
  #pastPanel{
    display:none;
    margin-top:10px;
    padding:12px;
    border:1px solid #444;
    border-radius:8px;
    background:#111;
  }
  #pastPanel label{
    white-space:nowrap;
    font-weight:800;
    margin-right:10px;
  }
  #pastPanel select{
    font-size: 1em;
    padding: 0.45em;
    background:#222;
    color:#fff;
    border:1px solid #555;
    border-radius:6px;
    margin-left:6px;
  }
</style>
</head>
<body>

<img class="banner" src="trim-tracker-banner.png" alt="Trim Tracker Banner"/>

<p style="color: #ccc; max-width: 700px; margin: 0 auto 20px;">
  <strong>Note:</strong> Your data is saved locally in your browser and will remain available unless you clear your cache or switch devices/browsers.
</p>

<table id="sessionTable">
  <thead>
    <tr>
      <th>Date</th>
      <th>Strain</th>
      <th>Grams</th>
      <th>Total</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>

<button onclick="addRow()">Add Row</button>
<button class="clear-all" onclick="clearPastEntries()">Clear Past Entries</button>
<button onclick="exportCSV()">Export CSV</button>
<input id="csvFileInput" type="file" accept=".csv" onchange="importCSV(event)" style="display: none;"/>
<button onclick="document.getElementById('csvFileInput').click()">Import CSV</button>

<!-- ✅ Past Entries Controls (Month + Week) -->
<div id="pastControls">
  <button id="togglePastPanelBtn" type="button" style="background:#444;">
    View Past Entries
  </button>

  <div id="pastPanel">
    <div style="display:flex; flex-wrap:wrap; gap:12px; align-items:center;">
      <label>
        Month:
        <select id="pastMonthSelect"></select>
      </label>

      <label>
        Week:
        <select id="pastWeekSelect"></select>
      </label>

      <button id="showWeekBtn" type="button" style="background:green;">Show Week</button>
      <button id="clearPastViewBtn" type="button" style="background:#666;">Clear Selection</button>
    </div>
  </div>
</div>

<a class="back-link" href="index.html" id="backLink">← Back to Calculator</a>

<div id="dailyTotals" style="margin-top: 30px; text-align: left; max-width: 800px; margin-left: auto; margin-right: auto;">
  <h3>Daily Totals</h3>
  <ul id="totalsList" style="list-style: none; padding: 0;"></ul>
</div>

<script>
  const lang = document.documentElement.lang;
  const storageKey = `trimTrackerData-${lang}`;
  let saveTimeout;

  /* ===================== Date helpers ===================== */

  // ✅ PST/PDT-safe ISO date (America/Los_Angeles)
  function getLAISODate(date = new Date()) {
    const parts = new Intl.DateTimeFormat('en-CA', {
      timeZone: 'America/Los_Angeles',
      year: 'numeric',
      month: '2-digit',
      day: '2-digit'
    }).formatToParts(date);

    const y = parts.find(p => p.type === 'year').value;
    const m = parts.find(p => p.type === 'month').value;
    const d = parts.find(p => p.type === 'day').value;
    return `${y}-${m}-${d}`;
  }

  function addDaysISO(iso, days){
    const d = new Date(iso + "T00:00:00");
    d.setDate(d.getDate() + days);
    return getLAISODate(d);
  }

  function monthKeyFromISO(iso){
    return (iso && /^\d{4}-\d{2}-\d{2}$/.test(iso)) ? iso.slice(0,7) : "";
  }

  function getCurrentMonthKey(){
    return getLAISODate().slice(0,7);
  }

  function monthLabel(monthKey){
    if (!/^\d{4}-\d{2}$/.test(monthKey)) return monthKey;
    const [y,m] = monthKey.split("-");
    const d = new Date(`${y}-${m}-01T00:00:00`);
    return d.toLocaleString("en-US", { month:"long", year:"numeric" });
  }

  // Week starts on Sunday (0). Change to 1 for Monday start if you ever want.
  function weekStartISO(iso, weekStartsOn = 0){
    const d = new Date(iso + "T00:00:00");
    const day = d.getDay(); // 0..6
    const diff = (day - weekStartsOn + 7) % 7;
    d.setDate(d.getDate() - diff);
    return getLAISODate(d);
  }

  function weekRangeLabel(weekStart){
    const end = addDaysISO(weekStart, 6);
    return `${weekStart} – ${end}`;
  }

  /* ===================== Save / debounce ===================== */

  function debounceSave() {
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(() => {
      if ('requestIdleCallback' in window) requestIdleCallback(saveData);
      else saveData();
    }, 300);
  }

  /* ===================== Row creation ===================== */

  function createGramInput(onChangeFunc, value = '') {
    const input = document.createElement('input');
    input.type = 'number';
    input.min = '0';
    input.step = '0.01';
    input.placeholder = 'g';
    input.value = value;

    input.oninput = () => {
      if (typeof onChangeFunc === 'function') onChangeFunc();
      debounceSave();
    };
    return input;
  }

  function addRow(data = {}, skipViewUpdate = false) {
    const tbody = document.getElementById('tableBody');
    const row = document.createElement('tr');

    const dateInput = document.createElement('input');
    dateInput.type = 'date';
    dateInput.value = data.date || getLAISODate();
    dateInput.oninput = () => {
      debounceSave();
      updateDailyTotals();
      updateView();
    };
    const dateCell = document.createElement('td');
    dateCell.appendChild(dateInput);
    row.appendChild(dateCell);

    const strainInput = document.createElement('input');
    strainInput.type = 'text';
    strainInput.value = data.strain || '';
    strainInput.oninput = debounceSave;
    const strainCell = document.createElement('td');
    strainCell.appendChild(strainInput);
    row.appendChild(strainCell);

    const gramsWrapper = document.createElement('div');
    gramsWrapper.style.display = 'flex';
    gramsWrapper.style.flexWrap = 'wrap';
    gramsWrapper.style.gap = '4px';

    const grams = data.grams || ['', '', ''];
    grams.forEach(g => gramsWrapper.appendChild(createGramInput(updateTotal, g)));

    const addGramBtn = document.createElement('button');
    addGramBtn.textContent = '+';
    addGramBtn.onclick = () => {
      gramsWrapper.appendChild(createGramInput(updateTotal));
      debounceSave();
    };

    const gramsCell = document.createElement('td');
    gramsCell.appendChild(gramsWrapper);
    gramsCell.appendChild(addGramBtn);
    row.appendChild(gramsCell);

    const totalCell = document.createElement('td');
    row.appendChild(totalCell);

    function updateTotal() {
      let sum = 0;
      gramsWrapper.querySelectorAll('input').forEach(input => {
        const val = parseFloat(input.value);
        if (!isNaN(val)) sum += val;
      });
      totalCell.innerText = sum.toFixed(2);
      updateDailyTotals();
    }
    updateTotal();

    const delBtn = document.createElement('button');
    delBtn.textContent = 'Delete';
    delBtn.className = 'delete-row';
    delBtn.onclick = () => {
      if (confirm('Delete this row?')) {
        row.remove();
        debounceSave();
        updateDailyTotals();
        updateView();
      }
    };
    const actionCell = document.createElement('td');
    actionCell.appendChild(delBtn);
    row.appendChild(actionCell);

    tbody.appendChild(row);
    if (!skipViewUpdate) updateView();
  }

  /* ===================== Past view state ===================== */

  const PAST_MONTH_KEY = "trimTrackerPastMonth_v2";
  const PAST_WEEK_KEY  = "trimTrackerPastWeek_v2";

  function getPastMonth(){ return localStorage.getItem(PAST_MONTH_KEY) || ""; }
  function setPastMonth(v){ localStorage.setItem(PAST_MONTH_KEY, v || ""); }

  function getPastWeek(){ return localStorage.getItem(PAST_WEEK_KEY) || ""; }
  function setPastWeek(v){ localStorage.setItem(PAST_WEEK_KEY, v || ""); }

  function clearPastSelection(){
    setPastMonth("");
    setPastWeek("");
    const mSel = document.getElementById("pastMonthSelect");
    const wSel = document.getElementById("pastWeekSelect");
    if (mSel) mSel.value = "";
    if (wSel) wSel.innerHTML = `<option value="">Select a month first</option>`;
    updateView();
  }

  function buildPastMonthOptions(allMonths){
    const sel = document.getElementById("pastMonthSelect");
    if (!sel) return;

    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "Select month...";
    sel.appendChild(opt0);

    allMonths.forEach(mk => {
      const opt = document.createElement("option");
      opt.value = mk;
      opt.textContent = monthLabel(mk);
      sel.appendChild(opt);
    });

    // ✅ if saved month doesn't exist anymore, clear it
    const saved = getPastMonth();
    if (saved && allMonths.includes(saved)) sel.value = saved;
    else {
      if (saved) { setPastMonth(""); setPastWeek(""); }
      sel.value = "";
    }
  }

  function buildPastWeekOptions(weeksForMonth){
    const sel = document.getElementById("pastWeekSelect");
    if (!sel) return;

    sel.innerHTML = "";

    if (!weeksForMonth.length){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "No weeks found";
      sel.appendChild(opt);
      // ✅ also clear saved week if it no longer exists
      if (getPastWeek()) setPastWeek("");
      return;
    }

    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "Select week...";
    sel.appendChild(opt0);

    weeksForMonth.forEach(ws => {
      const opt = document.createElement("option");
      opt.value = ws;
      opt.textContent = weekRangeLabel(ws);
      sel.appendChild(opt);
    });

    // ✅ if saved week not in this list, clear it
    const saved = getPastWeek();
    if (saved && weeksForMonth.includes(saved)) sel.value = saved;
    else {
      if (saved) setPastWeek("");
      sel.value = "";
    }
  }

  // ✅ Always rebuild week dropdown immediately when month changes
  function wirePastControls(getWeeksForMonthFn){
    const toggleBtn = document.getElementById("togglePastPanelBtn");
    const panel = document.getElementById("pastPanel");
    const monthSel = document.getElementById("pastMonthSelect");
    const weekSel = document.getElementById("pastWeekSelect");
    const showBtn = document.getElementById("showWeekBtn");
    const clearBtn = document.getElementById("clearPastViewBtn");

    if (toggleBtn && panel){
      toggleBtn.addEventListener("click", () => {
        panel.style.display = (panel.style.display === "none") ? "block" : "none";
      });
    }

    if (monthSel){
      monthSel.addEventListener("change", () => {
        setPastMonth(monthSel.value || "");
        setPastWeek("");
        // Build weeks right away from fresh data
        const weeks = (typeof getWeeksForMonthFn === "function")
          ? getWeeksForMonthFn(monthSel.value || "")
          : [];
        buildPastWeekOptions(weeks);
      });
    }

    if (weekSel){
      weekSel.addEventListener("change", () => {
        setPastWeek(weekSel.value || "");
      });
    }

    if (showBtn){
      showBtn.addEventListener("click", () => {
        const mk = monthSel ? monthSel.value : "";
        const wk = weekSel ? weekSel.value : "";
        if (!mk){ alert("Select a month."); return; }
        if (!wk){ alert("Select a week."); return; }

        // ✅ verify the week exists for that month
        const weeks = (typeof getWeeksForMonthFn === "function")
          ? getWeeksForMonthFn(mk)
          : [];
        if (!weeks.includes(wk)){
          alert("That week is not available for that month. Pick another week.");
          setPastWeek("");
          buildPastWeekOptions(weeks);
          return;
        }

        setPastMonth(mk);
        setPastWeek(wk);
        updateView();
        document.getElementById("sessionTable")?.scrollIntoView({behavior:"smooth"});
      });
    }

    if (clearBtn){
      clearBtn.addEventListener("click", clearPastSelection);
    }
  }

  /* ===================== Collapsible renderer (Week headers) ===================== */

  function makeHeaderRow(kind, labelHTML, colspan=5){
    const tr = document.createElement("tr");
    tr.className = (kind === "month") ? "group-header" : "sub-header";
    const td = document.createElement("td");
    td.colSpan = colspan;
    td.innerHTML = labelHTML;
    tr.appendChild(td);
    return { tr, td };
  }

  function toggleRows(rows, show){
    rows.forEach(r => r.style.display = show ? "" : "none");
  }

  /* ===================== Main renderer ===================== */

  function updateView() {
    const tbody = document.getElementById('tableBody');

    // Grab ONLY real data rows
    const allRows = Array.from(tbody.querySelectorAll('tr'))
      .filter(r => !r.classList.contains('group-header') &&
                   !r.classList.contains('sub-header') &&
                   !r.classList.contains('divider-row'));

    // Build date->rows map
    const todayISO = getLAISODate();
    const currentMonth = getCurrentMonthKey();

    const rowsByDate = {};
    allRows.forEach(row => {
      const date = row.querySelector('input[type="date"]')?.value;
      if (!date) return;
      if (!rowsByDate[date]) rowsByDate[date] = [];
      rowsByDate[date].push(row);
    });

    // Total helper
    const rowsTotal = (rows) => rows.reduce((sum, r) => {
      const totalCell = r.querySelector('td:nth-child(4)');
      const grams = parseFloat(totalCell?.innerText || 0);
      return sum + (isNaN(grams) ? 0 : grams);
    }, 0);

    // Build current-month weeks + past months/weeks
    const currentMonthWeeks = {}; // weekStart -> rows
    const pastMonths = new Set();
    const weeksByPastMonth = {};  // month -> Set(weekStart)

    Object.keys(rowsByDate).forEach(dateISO => {
      const mk = monthKeyFromISO(dateISO);
      const ws = weekStartISO(dateISO, 0);
      if (mk === currentMonth){
        if (!currentMonthWeeks[ws]) currentMonthWeeks[ws] = [];
        rowsByDate[dateISO].forEach(r => currentMonthWeeks[ws].push(r));
      } else if (mk) {
        pastMonths.add(mk);
        if (!weeksByPastMonth[mk]) weeksByPastMonth[mk] = new Set();
        weeksByPastMonth[mk].add(ws);
      }
    });

    // Helper so month change can rebuild weeks immediately
    window.__getWeeksForMonth = (mk) => {
      if (!mk || !weeksByPastMonth[mk]) return [];
      return Array.from(weeksByPastMonth[mk]).sort((a,b) => (a < b ? 1 : -1));
    };

    // Rebuild dropdowns from data
    const pastMonthList = Array.from(pastMonths).sort((a,b) => (a < b ? 1 : -1));
    buildPastMonthOptions(pastMonthList);

    const selectedMonth = getPastMonth();
    const weeksForSelectedMonth = window.__getWeeksForMonth(selectedMonth);
    buildPastWeekOptions(weeksForSelectedMonth);

    // ✅ If saved week is invalid after rebuilding options, it will be cleared above
    const selectedWeek = getPastWeek();

    // Now rebuild table display
    tbody.innerHTML = "";

    // 1) Today rows (always visible)
    if (rowsByDate[todayISO]) {
      rowsByDate[todayISO].forEach(r => {
        r.style.display = "";
        tbody.appendChild(r);
      });
    }

    // 2) Current month grouped by week, excluding today
    const currentWeekStart = weekStartISO(todayISO, 0);
    const weekKeys = Object.keys(currentMonthWeeks).sort((a,b) => (a < b ? 1 : -1));

    weekKeys.forEach(ws => {
      const weekRows = currentMonthWeeks[ws].filter(r => {
        const d = r.querySelector('input[type="date"]')?.value;
        return d && d !== todayISO;
      });

      if (!weekRows.length) return;

      const weekTotal = rowsTotal(weekRows);
      const isCurrentWeek = (ws === currentWeekStart);

      const { tr: weekHeader, td: weekTd } = makeHeaderRow(
        "week",
        `<span class="tag">${isCurrentWeek ? "THIS WEEK" : "WEEK"}</span>
         ${weekRangeLabel(ws)} — Total: ${weekTotal.toFixed(2)}g
         <span style="float:right;">[+]</span>`
      );

      let open = false;
      toggleRows(weekRows, false);

      weekHeader.addEventListener("click", () => {
        open = !open;
        toggleRows(weekRows, open);
        weekTd.innerHTML =
          `<span class="tag">${isCurrentWeek ? "THIS WEEK" : "WEEK"}</span>
           ${weekRangeLabel(ws)} — Total: ${weekTotal.toFixed(2)}g
           <span style="float:right;">[${open ? "-" : "+"}]</span>`;
      });

      tbody.appendChild(weekHeader);
      weekRows.forEach(r => { r.style.display = "none"; tbody.appendChild(r); });
    });

    // 3) Past month/week view (ONLY if valid AND has rows)
    if (selectedMonth && selectedWeek) {
      const matchingDates = Object.keys(rowsByDate)
        .filter(d => monthKeyFromISO(d) === selectedMonth && weekStartISO(d,0) === selectedWeek)
        .sort((a,b) => (a < b ? 1 : -1));

      const pastRows = [];
      matchingDates.forEach(d => rowsByDate[d].forEach(r => pastRows.push(r)));

      // ✅ If selection exists but yields no rows, don't render the dead block
      if (!pastRows.length) {
        // Clear invalid week selection silently
        setPastWeek("");
        return;
      }

      const divider = document.createElement("tr");
      divider.className = "divider-row";
      const td = document.createElement("td");
      td.colSpan = 5;
      td.innerHTML = `Past Entries — ${monthLabel(selectedMonth)} / ${weekRangeLabel(selectedWeek)}`;
      divider.appendChild(td);
      tbody.appendChild(divider);

      const pastTotal = rowsTotal(pastRows);

      const { tr: pastWeekHeader, td: pastWeekTd } = makeHeaderRow(
        "week",
        `<span class="tag">WEEK</span>
         ${weekRangeLabel(selectedWeek)} — Total: ${pastTotal.toFixed(2)}g
         <span style="float:right;">[+]</span>`
      );

      let open = false;
      toggleRows(pastRows, false);

      pastWeekHeader.addEventListener("click", () => {
        open = !open;
        toggleRows(pastRows, open);
        pastWeekTd.innerHTML =
          `<span class="tag">WEEK</span>
           ${weekRangeLabel(selectedWeek)} — Total: ${pastTotal.toFixed(2)}g
           <span style="float:right;">[${open ? "-" : "+"}]</span>`;
      });

      tbody.appendChild(pastWeekHeader);
      pastRows.forEach(r => { r.style.display = "none"; tbody.appendChild(r); });
    }
  }

  /* ===================== Totals + clear ===================== */

  function updateDailyTotals() {
    const rows = document.querySelectorAll('#tableBody tr');
    const totalsMap = {};

    Array.from(rows)
      .filter(r => !r.classList.contains('group-header') &&
                   !r.classList.contains('sub-header') &&
                   !r.classList.contains('divider-row'))
      .forEach(row => {
        const date = row.querySelector('input[type="date"]')?.value;
        const total = parseFloat(row.querySelector('td:nth-child(4)')?.innerText) || 0;
        if (date) {
          if (!totalsMap[date]) totalsMap[date] = 0;
          totalsMap[date] += total;
        }
      });

    const today = getLAISODate();
    const todayStorageKey = 'trimTrackerDailyTotal-' + today;

    if (totalsMap[today] !== undefined) {
      localStorage.setItem(todayStorageKey, totalsMap[today].toFixed(2));
    } else {
      localStorage.removeItem(todayStorageKey);
    }

    const totalsList = document.getElementById('totalsList');
    if (totalsList) {
      totalsList.innerHTML = '';
      Object.entries(totalsMap)
        .sort((a, b) => b[0].localeCompare(a[0]))
        .forEach(([date, total]) => {
          const li = document.createElement('li');
          li.textContent = `${date}: ${total.toFixed(2)}g`;
          totalsList.appendChild(li);
        });
    }
  }

  function clearPastEntries() {
    const today = getLAISODate();
    const confirmMsg = `Are you sure you want to clear ALL past entries and keep only today's (${today}) entries?`;
    if (!confirm(confirmMsg)) return;

    const tbody = document.getElementById('tableBody');
    if (!tbody) return;

    const rows = Array.from(tbody.querySelectorAll('tr'))
      .filter(r => !r.classList.contains('group-header') &&
                   !r.classList.contains('sub-header') &&
                   !r.classList.contains('divider-row'));

    rows.forEach(row => {
      const dateVal = row.querySelector('input[type="date"]')?.value;
      if (dateVal && dateVal !== today) row.remove();
    });

    const hasToday = Array.from(tbody.querySelectorAll('tr'))
      .filter(r => !r.classList.contains('group-header') &&
                   !r.classList.contains('sub-header') &&
                   !r.classList.contains('divider-row'))
      .some(r => r.querySelector('input[type="date"]')?.value === today);

    if (!hasToday) {
      addRow({ date: today, strain: '', grams: ['', '', ''] }, true);
    }

    clearPastSelection();
    debounceSave();
    updateDailyTotals();
    updateView();
  }

  /* ===================== Save/load ===================== */

  function saveData() {
    const rows = document.querySelectorAll('#tableBody tr');
    const data = Array.from(rows)
      .filter(row => !row.classList.contains('group-header') &&
                     !row.classList.contains('sub-header') &&
                     !row.classList.contains('divider-row'))
      .map(row => {
        const date = row.querySelector('input[type="date"]')?.value || '';
        const strain = row.querySelector('input[type="text"]')?.value || '';
        const grams = Array.from(row.querySelectorAll('td:nth-child(3) input')).map(input => input.value);
        return { date, strain, grams };
      });
    localStorage.setItem(storageKey, JSON.stringify(data));
  }

  function loadData() {
    const stored = localStorage.getItem(storageKey);
    if (stored) {
      try {
        const data = JSON.parse(stored);
        if (Array.isArray(data)) data.forEach(entry => addRow(entry, true));
        else addRow({}, true);
      } catch (e) {
        addRow({}, true);
      }
    } else {
      addRow({}, true);
    }
  }

  /* ===================== CSV import/export ===================== */

  function exportCSV() {
    const rows = document.querySelectorAll('#tableBody tr');
    let csvContent = 'Date,Strain,"Grams (semicolon separated)",Total\n';

    Array.from(rows)
      .filter(r => !r.classList.contains('group-header') &&
                   !r.classList.contains('sub-header') &&
                   !r.classList.contains('divider-row'))
      .forEach(row => {
        const date = `"${(row.querySelector('input[type="date"]')?.value || '').replace(/"/g, '""')}"`;
        const strain = `"${(row.querySelector('input[type="text"]')?.value || '').replace(/"/g, '""')}"`;
        const grams = `"${Array.from(row.querySelectorAll('td:nth-child(3) input'))
          .map(input => input.value)
          .join(';')
          .replace(/"/g, '""')}"`;
        const total = `"${(row.querySelector('td:nth-child(4)')?.innerText || '0').replace(/"/g, '""')}"`;

        csvContent += `${date},${strain},${grams},${total}\n`;
      });

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.setAttribute('href', url);
    link.setAttribute('download', 'trim_tracker.csv');
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  }

  function importCSV(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function (e) {
      try {
        const text = e.target.result;
        const lines = text.split('\n').slice(1);
        let importedCount = 0;
        let skippedCount = 0;

        lines.forEach(line => {
          const trimmedLine = line.trim();
          if (!trimmedLine) return;

          const columns = trimmedLine.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);

          if (columns && columns.length >= 3) {
            const date = columns[0].replace(/^"|"$/g, '').trim();
            const strain = columns[1].replace(/^"|"$/g, '').trim();
            const gramsString = columns[2].replace(/^"|"$/g, '');
            const grams = gramsString.split(';').map(g => g.trim());

            if (/^\d{4}-\d{2}-\d{2}$/.test(date)) {
              addRow({ date, strain, grams }, true);
              importedCount++;
            } else {
              skippedCount++;
            }
          } else {
            skippedCount++;
          }
        });

        debounceSave();
        updateDailyTotals();
        updateView();

        let feedbackMsg = `Import completed. ${importedCount} row(s) imported.`;
        if (skippedCount > 0) feedbackMsg += ` ${skippedCount} row(s) skipped due to errors.`;
        alert(feedbackMsg);
      } catch (e) {
        alert('Error importing CSV file.');
      }
    };
    reader.onerror = function () { alert('Error reading file.'); };
    reader.readAsText(file);
    event.target.value = '';
  }

  /* ===================== Init ===================== */

  document.addEventListener('DOMContentLoaded', () => {
    loadData();

    // wire the panel using the weeks function updateView defines every time it runs
    wirePastControls((mk) => (window.__getWeeksForMonth ? window.__getWeeksForMonth(mk) : []));

    requestAnimationFrame(() => {
      updateDailyTotals();
      updateView();
    });
  });
</script>

</body>
</html>
